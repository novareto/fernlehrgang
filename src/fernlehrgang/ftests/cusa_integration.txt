======
Ablauf
======

:Test-Layer: functional

Dieser Doctest soll mal zeigen wie ein Ablauf eines Fernlehrgangs aussehen könnte...


Setup
-----

Zunächst müssen wir erneut eine Instanz von unserer Application anlegen,
uma alle Utilities zur Verfügung zu haben.

   >>> from fernlehrgang.app import FernlehrgangApp
   >>> from z3c.saconfig import Session
   >>> root = getRootFolder()
   >>> root = {}
   >>> app = FernlehrgangApp()
   >>> root['app'] = FernlehrgangApp()
   

Einrichten des Fernlehrgangs
----------------------------

   >>> from fernlehrgang.models import Fernlehrgang, Lehrheft, Frage

   >>> import datetime
   >>> beginn = datetime.date(2010,1,1)
   >>> ende = datetime.date(2010,12,31)

   >>> flg09 = Fernlehrgang(jahr="2009", titel="Fernlehrgang", typ="4", punktzahl=1,
   ...                      beschreibung="Beschreibung", beginn=beginn, ende=ende)    

   >>> lheft1 = Lehrheft(nummer=1)

   >>> frage1 = Frage(frage=1, antwortschema="ab")

   >>> lheft1.fragen.append(frage1) 

   >>> flg09.lehrhefte.append(lheft1)

   >>> session = Session()
   >>> session.add(flg09)
   >>> import transaction; transaction.commit()

    

Unternehmen mit keinen Teilnehmern
----------------------------------

   >>> from fernlehrgang.models import Unternehmen
   >>> from fernlehrgang.interfaces.cusa_result import ICusaResult

   >>> session = Session()
   >>> unt1 = Unternehmen(mnr="0000-00025", name="Novareto")
   >>> session.add(unt1)

   >>> len(unt1.teilnehmer)
   0

   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='nicht angelegt', message='Kein Unternehmermodel BGHW', flg='', kompetenzzentrum='', titel='', name='')


Unternehmen mit Teilnehmern angelegt
------------------------------------

   >>> from fernlehrgang.models import Teilnehmer, Kursteilnehmer

   >>> teilnehmer = Teilnehmer(name="Lars Walther")
   >>> kt1 = Kursteilnehmer(status="A2")
   >>> kt2 = Kursteilnehmer(status="A1")
   >>> teilnehmer.kursteilnehmer.append(kt1)
   >>> unt1.teilnehmer.append(teilnehmer)
   >>> flg = session.query(Fernlehrgang).get(1)
   >>> flg.kursteilnehmer.append(kt1)
   >>> import transaction; transaction.commit()

   >>> unt1.teilnehmer
   [<Teilnehmer(id='1', name='1')>]
   

Teilnehmer nicht registriert

   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='nicht registriert', message='nicht bestanden (kein TN angemeldet)', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "L1" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "L1"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='UN-Modell anderer UV-Träger', message='Teilnahme nicht erforderlich', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "L2" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "L2"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Grund- bzw. Regelbetreuung', message='Teilnahme nicht erforderlich', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "L3" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "L3"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Keine Beschäftigten', message='Teilnahme nicht erforderlich', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "L4" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "L4"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Teilnahme aus pers. Gründen verschoben', message='nicht bestanden', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "L5" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "L5"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Teilnahme ist bereits erfolgt', message='Teilnahme nicht erforderlich', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "L6" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "L6"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Aufgabe des Unternehmens', message='Teilnahme nicht erforderlich', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "L7" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "L7"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Teilnehmer nicht mehr im Unternehmen', message='nicht bestanden (Teilnehmer ausgeschieden)', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "L8" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "L8"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Unternehmer nicht aktiv im Betriebsgeschehen', message='nicht bestanden (keine Berechtigung)', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "S1" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "S1"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Interner Fehler', message='nicht bestanden (Export Notiz)', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "Z1" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "Z1"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='Bearbeitungsfrist abgelaufen', message='Teilnahme nicht erforderlich', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


Teilnehmer mit Status "A2" 

   >>> unt1.teilnehmer[0].kursteilnehmer[0].status = "A2"
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='nicht registriert', message='nicht bestanden (kein TN angemeldet)', flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')



Teilnehmer mit Antworten
------------------------

   >>> session.flush()
   >>> from fernlehrgang import models
   >>> from fernlehrgang.interfaces.kursteilnehmer import IVLWKursteilnehmer
   >>> from fernlehrgang.interfaces.resultate import ICalculateResults
   >>> ktn1 = session.query(models.Kursteilnehmer).get('1')   
   >>> print(ktn1)
   <Kursteilnehmer(id='1', fernlehrgangid='1')>

   >>> IVLWKursteilnehmer.providedBy(ktn1)
   True

   >>> ktn1.status = "A1"
   >>> unt1 = session.query(models.Unternehmen).get('0000-00025')
   >>> results = ICalculateResults(ktn1)
   >>> results
   <fernlehrgang.browser.ergebnisse.CalculateResultsVLW object at ...>
   
   >>> results.summary()
   {'points': 0, 'resultpoints': 0, 'comment': "<b> <span class='text-danger'> Nicht Bestanden (VLW noch nicht vollständig bearbeitet); </span> </b> "}

   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='angemeldet', message="<b> <span class='text-danger'> Nicht Bestanden (VLW noch nicht vollständig bearbeitet); </span> </b> ", flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')
  
   >>> antwort = models.Antwort(lehrheft_id=lheft1.id, frage_id=frage1.id, gbo="OK")
   >>> ktn1.antworten.append(antwort) 

   >>> res = print(results.summary())
   {'points': 0, 'resultpoints': 0, 'comment': "<b> <span class='text-success'> Bestanden; </span> </b> "}


   >>> unt1 = session.query(models.Unternehmen).get('0000-00025')
   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.calculate()
   CUSAResult(status='angemeldet', message="<b> <span class='text-success'> Bestanden; </span> </b> ", flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')


   >>> kt2 = Kursteilnehmer(status="A1")
   >>> teilnehmer = session.query(models.Teilnehmer).get(1)
   >>> teilnehmer.kursteilnehmer.append(kt2)
   >>> flg = session.query(Fernlehrgang).get(1)
   >>> flg.kursteilnehmer.append(kt2)
   >>> session.flush()


   >>> cusa_result = ICusaResult(unt1)
   >>> cusa_result.get_kursteilnehmer()
   [<Kursteilnehmer(id='2', fernlehrgangid='1')>, <Kursteilnehmer(id='1', fernlehrgangid='1')>]
   >>> cusa_result.calculate()
   CUSAResult(status='angemeldet', message="<b> <span class='text-success'> Bestanden; </span> </b> ", flg='2009', kompetenzzentrum=None, titel='Fernlehrgang', name='Lars Walther, None')
